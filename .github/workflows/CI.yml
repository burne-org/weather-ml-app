name: CI Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-test-ship:
    runs-on: self-hosted

    steps:
    # 1. Checkout Code
    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. Set up Python 3.9
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. Install Dependencies (Includes scikit-learn & pandas from requirements.txt)
    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    # 4. Train Model (Generates weather_model.pkl so unit tests don't fail)
    - name: Train Model
      run: python3 train_model.py

    # 5. Run Tests (With PYTHONPATH set so tests can find app.py)
    - name: Run Smoke Test
      run: |
        export PYTHONPATH=$PYTHONPATH:.
        python3 -m unittest tests/smoke_test.py

    - name: Run Unit Test
      run: |
        export PYTHONPATH=$PYTHONPATH:.
        python3 -m unittest tests/unit_test.py

    - name: Run Integration Test
      run: |
        export PYTHONPATH=$PYTHONPATH:.
        python3 -m unittest tests/integration_test.py

    # 6. Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USER }}
        password: ${{ secrets.DOCKER_PASS }}

    # 7. Build Docker Image locally (Task 4.2: Load to local Docker, do not push yet)
    - name: Build Docker Image (No Push)
      uses: docker/build-push-action@v5
      with:
        context: .
        load: true
        tags: ${{ secrets.DOCKER_USER }}/weather-ml-app:v1

    # 8. Build Test (Task 4.2 Spec Requirement)
    - name: Build Test (Run, Sleep, Curl)
      run: |
        # CRITICAL FIX: Force remove any old container to prevent "Conflict" errors
        docker rm -f build-test-container || true
        
        # Run the container in detached mode
        docker run -d -p 5000:5000 --name build-test-container ${{ secrets.DOCKER_USER }}/weather-ml-app:v1
        
        # Sleep for 10 seconds to allow the app to initialize
        sleep 10
        
        # Verify the app is running by curling localhost
        echo "Testing application URL..."
        curl -v http://localhost:5000
        
        # Cleanup: Stop and remove the container
        docker stop build-test-container
        docker rm build-test-container

    # 9. Push Docker Image (Only runs if the test above passes)
    - name: Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ secrets.DOCKER_USER }}/weather-ml-app:v1
